{{!--
  Fail2Ban Installation Script for Debian/Ubuntu
  Variables:
    - installFail2ban (boolean)
    - fail2banSSHBanTime (number, fallback 3600)
    - fail2banSSHMaxRetry (number, fallback 5)
--}}

echo "🛡️ Installing and configuring Fail2Ban..."

sudo apt-get update
sudo apt-get install --yes fail2ban

sudo mkdir --parents /etc/fail2ban

sudo tee /etc/fail2ban/jail.local > /dev/null <<EOF
[DEFAULT]
bantime = {{fail2banSSHBanTime}}

[sshd]
enabled = true
port = ssh
logpath = %(sshd_log)s
backend = %(sshd_backend)s
maxretry = {{fail2banSSHMaxRetry}}
EOF

echo "🔄 Enabling and starting Fail2Ban service..."
sudo systemctl enable fail2ban
sudo systemctl restart fail2ban

echo "✅ Fail2Ban installation and configuration completed!"
echo "🔍 Fail2Ban status:"
sudo fail2ban-client status

echo "🔍 SSH jail status:"
sudo fail2ban-client status sshd
