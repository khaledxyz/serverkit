{{!--
  Fail2Ban Installation Script for Debian/Ubuntu
  Variables:
    - installFail2ban (boolean)
    - fail2banSSHBanTime (number, fallback 3600)
    - fail2banSSHMaxRetry (number, fallback 5)
--}}

{{#if installFail2ban}}
echo "🛡️ Installing and configuring Fail2Ban..."

sudo apt-get update
sudo apt-get install -y fail2ban

sudo mkdir -p /etc/fail2ban

sudo tee /etc/fail2ban/jail.local > /dev/null <<EOF
[DEFAULT]
bantime = {{fail2banSSHBanTime ?? 3600}}

[sshd]
enabled = true
port = ssh
logpath = %(sshd_log)s
backend = %(sshd_backend)s
maxretry = {{fail2banSSHMaxRetry ?? 5}}
EOF

echo "🔄 Enabling and starting Fail2Ban service..."
sudo systemctl enable fail2ban
sudo systemctl restart fail2ban

echo "✅ Fail2Ban installation and configuration completed!"
echo "🔍 Fail2Ban status:"
sudo fail2ban-client status

echo "🔍 SSH jail status:"
sudo fail2ban-client status sshd

{{else}}
echo "⚠️ Fail2Ban installation not enabled."
{{/if}}
